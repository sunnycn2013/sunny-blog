### 浅谈iOS架构设计

- 浅谈iOS架构设计
	- 表示层开发
	- 客户端业务逻辑的剥离
    - App组件SDK化(插件化之路)
	- 网络层DNS预解析
	- 图片资源服务器
	

之前市面上有大量的关于讨论iOS架构的一些问题，各式各样 百家争鸣。有关于设计模式的、业务划分的、app内部各种实现手段的。整体来说就我个人理解而言，架构的产生只是为了解决某种特定需求、特定场景下的特殊问题。架构无处不在，但是好的架构确不尽唯一。就像这个世界没有绝对的好与坏，每个人都有自己的特定需求。整体来说一个好的架构会决定着软件的后期的维护、开发是否具有可持续集成的可行性。作为一个设计师我们要做的学百家之所长，不断的完善自己，不意味的盲目的崇拜、推崇，做到手中无构，世间万物皆无构...

>
序言：随着iOS工程化的进度愈发加深，越来越多的团队面临的问题不在是如何为现有的软件追加一些新得功能模块，随着业务的拓展，对软件自身框架方面的问题也显得势在必行，模块与模块的之间的解耦合、模块间的相互独立，工程的组件化等显得越来越重要，本篇文章主要基于现有App工程中使用到的一些规范外加一些个人的理解总结，希望能够给予大家以学习上的帮助。

#### 表示层开发模式
##### 表示层的开发
客户端就表现层而言基本大家基本都采用MVC方式来开发，随着业务的演化可能逐步转变成MVVM，相对来说这些都是基于页面层的。无论是哪一种设计原则都是由MVC演变而来。相对当前的app来说，业务层面迭代速度较快，这一层次的开发经常面临着比较尴尬的场景，频繁的代码重构、解耦合...

iOS自身的开发特性是基于MVC的来构建的，随着业务场景变得愈发复杂，引入了MVVM。无论是MVVM还是MVP都是只是针对表现层代码的逻辑性质做了进一步的分割，使得代码的维护更加有章可循、有据可守。Presenter层（顾名思义，主持人 表演者的意思）在WPF的页面绑定中担任持有、变更数据。bind数据的角色，MVP也正是有此处诞生，整体来说类似于Controller层。相对ViewViewModel层可能担任的角色更为广泛，除了需要处理一些数据的持有、获取、网络之外还需要担任一部分UI的特有的属性以及接口工作。更通俗一点来讲viewModel要处理的相关的一些操作范围更广、更容易成为一个无法从质上作出定义的一个实质存在。

曾经有段时间社区里面流行一种叫做面向协议的编程规范，在大综业务场景模式下(如：大量同类型业务场景的商品、视图、cell、操作)如果真对每一种特例都去对应的枚举处理，其结果难以想象。这一点借鉴了Java 中接口式编程的法则，真对同一类型的事物抽象出公共的协议，在实际吃的操作过程中统一采用id<protocal>的形式去完成，这一点充分也体现了oop思想里面的多态性的思想。

##### 客户端业务逻辑的剥离
曾经有人这样问我，你们iOS的客户端采用了什么样的架构。当时我想来想去没有一个比较合适的回答，结果反倒被对方反问：是三层架构吗？我已经不太记得当时的回答了，大概意思只是说了一些客户端与服务端一些本质区别内容的回答。事后我想了很久，也反思了很久。再到后来我渐渐的画出了自己的答案。

<img src="http://7xtyxb.com1.z0.glb.clouddn.com/sanceng.png" width="584" height="404"></img>

在传统的服务端最初为了实现基本业务的分离诞生了基本的三层模型

```
 界面层 User Interface layer 
 业务逻辑层 Business Logic Layer
 数据访问层 Data access layer
```
基于业务的划分，从而进一步达到高内聚、低耦合的目标，更有益于后期业务的维护与开发。基于以上这个模型慢慢衍生最终产生了

```
 前端界面层 User Interface layer 
- - - - - - - - - - - - - - - - - - - - - - - - - - 
 服务层 Service  .....
- - - - - - - - - - - - - - - - - - - - - - - - - - 
 － 业务逻辑层 Business Logic Layer
 － 数据访问层 Data access layer
```
基于心得架构完全实现了前后端的分离，中间采用service的形势进行对接，其实具体的业务场景可能真对服务层进行进一步的架构分离，最终可能是基本的三层，也可能是七层，可能会更多。

相对来说，客户端具有根服务端不尽相同的场景，客户端本质来说就是一个前端，这一点根PC前端没有区别(PC前后段完全分离的模式目前普及到大家小巷)，客户端通过网络服务
获取数据，然后通过一些列操作最终将数据展示到手机屏幕上或者将操作结果发送到服务端。目前App从业务上架构的划分大题如上。

真对一个电商app，大概将app分成基本业务层、基础服务层、核心服务层
基本业务层
真对用户来说打开一个电商为主的app首先看到的应该是各种促销的活动版块、社交模块、我的个人中心等，这一块属于运营活动的范畴。这一块完全是用户的视野窗口，
这一块的产品质量的好坏直接影响的用户的第一直觉效果。

基础服务层
用户会选择对应的商品进入商详，最终选择商品加入购物车、提交订单、支付一些列操作，这一块主要作为电商app的基础模块，是电商app不可缺少的一部分。

核心服务层
真对任何一个app来讲，总要有一部分公共核心组件，统计、监控、IM、crash收集、支付等SDK，除了基础SDK还有网络层、基础通用UI控件等，

客户端基于业务的划分在实际的开发过程中有助于各个模块的开发人员可以完全专注于自己的业务模块，不同的业务场景模块真对软件的要求是不一样，运营相关的页面可能更多的面临着
迭代速度快、更新频繁，用户曝光量高，一个活动可能在经历两个比较大的模块后就会废弃，支付、购物车、商详的模块可能更新的频率比较低，但是数据处理量比较大，稳定性要求比
较高。

##### App组件化之路(插件化)
在大一点的Team中随着业务继续深入，组件化显得越来越重要。随着业务的迭代，问题会越来越明显。删除子模块是否是否影响到全局，再到更改某些模块的对外接口是否影响到全局的调用，再到将某些模块作为一个整体组件整体拷贝到其他的app工程中是否可以完美运行。这些工作越来越来显得愈发重要。如淘宝、天猫中的聚划算、秒杀插件等。

在整体的业务布局中，作为某条业务线上的一个coder，每个人都只是一个螺钉的作用（自从进入到现在团队感觉自己能接触东西越来越专注一个方向，同样也是越来越单一，私底下不得不尝试着去做主动学习一些其它的）在大的业务场景下，有些需求可能不是座位一个开发的角度所能考虑到的。作为战略化的考虑我们也会面临着这样的场景，将某个模块完全拷贝到另一个工程中去跑（类似于聚划算这样的）。这一点对模块的独立性、隔离程度要求都是相对比较高的。

客户端为什么会走向组件化，这样做有什么对应的目的。组件化最重的目的是为了最终实现模块的隔离。

iOS组件化与安卓组件化的对比此处就不做对比了，安卓组件化能做的会比iOS更多。此处只谈iOS平台相关的组件化。
关于组件化的文章，之前有蘑菇街的组件化的文章，不少人对此也褒贬不一。整体来说组件化的工作愈发必然，但终归到底要不要统一的按照一种特定的模式去做却是不尽必然。整体来讲蘑菇街的大体上分几块入手：业务拆分剥离、统一跳转组件化、核心模块集成化、UI控件统一化。其中统一跳转蘑菇街采用了一种类似于OpenUrl:"mgj:/*"的形势，可能这样做为了迎合iOS中自身的一种唤醒规范，这一点备受诟病（没有必要非的做的根系统一模一样，费神又费力...）



##### 网络层DNS预解析


##### 图片资源服务器


[蘑菇街 App 的组件化之路](http://www.360doc.com/content/16/0316/13/25724933_542663459.shtml)

[糯米移动组件架构演进之路－	邱晨](http://mp.weixin.qq.com/s?__biz=MzA3ODg4MDk0Ng==&mid=2651112195&idx=1&sn=27fa638e90b09a107057e4a5e8d01ab1&scene=23&srcid=0509XYc90zRgbglPF6AVbmkh#rd)

[滴滴iOS客户端的架构演变之路－李贤辉](http://www.infoq.com/cn/news/2016/03/lixianhui-interview)

[iOS遗留系统重构实践-李剑](http://www.infoq.com/cn/articles/ios-legacy-codebase-refactor?utm_campaign=rightbar_v2&utm_source=infoq&utm_medium=articles_link&utm_content=link_text)

[App域名劫持之DNS高可用 - 开源版HttpDNS方案详解](http://www.tuicool.com/articles/7nAJBb)

[【鹅厂网事】全局精确流量调度新思路-HttpDNS服务详解](http://mp.weixin.qq.com/s?__biz=MzA3ODgyNzcwMw==&mid=201837080&idx=1&sn=b2a152b84df1c7dbd294ea66037cf262&scene=2&from=timeline&isappinstalled=0&utm_source=tuicool)